stages:
    - build
    - deploy

build-test:
    stage: build
    image: node:8.12-alpine

    script:
        - uname -a
        - apk add g++ make python python-dev python3 python3-dev 
        - apk --update add libxml2-dev libxslt-dev gcc musl-dev libgcc openssl-dev curl
        - apk add jpeg-dev zlib-dev freetype-dev lcms2-dev openjpeg-dev tiff-dev tk-dev tcl-dev libwebp-dev libffi-dev cairo-dev
        - which npm
        - which python
        - python --version
        - python3 --version
        - python3 -m venv .venv
        - . .venv/bin/activate
        - npm install
        - python3 setup.py install
        - DJANGO_SETTINGS_MODULE=ams.settings.dev ./manage.py migrate
    only:
        - master

push:
    stage: deploy
    image: local-git-ssh
    before_script:
        - mkdir -p ~/.ssh
        - eval $(ssh-agent -s)
        - 'echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
        - 'echo "$STAGING_PRIVATE_KEY" > ~/.ssh/id_ed25519'
        - chmod 600 ~/.ssh/id_ed25519
    script:
        - git remote add deploy gl-amsalgo@obrien.akvorrat.at:/home/git/amsalgorithmus.at || true
        - git push --force deploy HEAD:master
    only:
        - master
